name: Deploy Infraestrutura de Dados

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  TF_VERSION: '1.5.0'
  ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
  ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
  ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
  ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

jobs:
  terraform:
    name: 'Terraform Plan & Apply'
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout do cÃ³digo
      - name: 'Checkout code'
        uses: actions/checkout@v4

      # 2. Login no Azure
      - name: 'Azure Login'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3. Setup do Terraform
      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # 4. Terraform Format Check
      - name: 'Terraform Format Check'
        run: |
          echo "ğŸ” Checking Terraform formatting..."
          terraform fmt -check -recursive
        continue-on-error: true

      # 5. Terraform Init
      - name: 'Terraform Init'
        run: |
          echo "ğŸ”§ Initializing Terraform..."
          terraform init
          echo "âœ… Terraform initialized!"

      # 6. Terraform Validate
      - name: 'Terraform Validate'
        run: |
          echo "âœ… Validating Terraform configuration..."
          terraform validate
          echo "âœ… Configuration is valid!"

      # 7. Terraform Plan
      - name: 'Terraform Plan'
        run: |
          echo "ğŸ“‹ Planning infrastructure changes..."
          terraform plan -out=tfplan
          echo "âœ… Plan complete!"

      # 8. Terraform Apply (sÃ³ na main e push)
      - name: 'Terraform Apply'
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "ğŸš€ Applying infrastructure changes..."
          echo "ğŸ’¾ Creating: SQL Server, Database, Storage Account..."
          terraform apply -auto-approve tfplan
          echo "âœ… Data infrastructure deployed successfully!"

      # 9. Terraform Output
      - name: 'Show Terraform Outputs'
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "ğŸ“Š Data Infrastructure Outputs:"
          terraform output -json
          echo ""
          echo "ğŸ” Important Resources:"
          echo "SQL Server: $(terraform output -raw sql_server_fqdn)"
          echo "Database: $(terraform output -raw sql_database_name)"
          echo "Storage Account: $(terraform output -raw storage_account_name)"     

      # 10. Logout do Azure
      - name: 'Azure Logout'
        if: always()
        run: |
          az logout
          echo "âœ… Logged out from Azure"